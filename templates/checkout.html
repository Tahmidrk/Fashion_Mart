{% extends "base.html" %}

{% block title %}Checkout - Fashion Mart{% endblock %}

{% block content %}
<div class="container">
    <h1 style="margin-bottom: 2rem;">Checkout</h1>
    
    <div id="checkoutContainer" style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
        <div>
            <div class="card" style="padding: 2rem; margin-bottom: 2rem;">
                <h2 style="margin-bottom: 1rem;">Delivery Address</h2>
                <div id="deliveryAddress" style="padding: 1rem; background: #f5f5f5; border-radius: 4px; margin-bottom: 1rem;">
                    <p><strong>{{ current_user.Name }}</strong></p>
                    <p>{{ current_user.Road }}, {{ current_user.Area }}</p>
                    <p>{{ current_user.City }}, {{ current_user.District }}</p>
                    <p>Phone: {{ current_user.Number }}</p>
                </div>
            </div>
            
            <div class="card" style="padding: 2rem; margin-bottom: 2rem;">
                <h2 style="margin-bottom: 1rem;">Payment Method</h2>
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <label class="payment-option" style="display: flex; align-items: center; padding: 1rem; border: 2px solid #ddd; border-radius: 8px; cursor: pointer;">
                        <input type="radio" name="paymentMethod" value="Cash on Delivery" checked style="margin-right: 1rem;">
                        <div>
                            <strong>Cash on Delivery</strong>
                            <div style="color: #666; font-size: 0.9rem;">Pay with cash when your order is delivered</div>
                        </div>
                    </label>
                    <label class="payment-option" style="display: flex; align-items: center; padding: 1rem; border: 2px solid #ddd; border-radius: 8px; cursor: pointer;">
                        <input type="radio" name="paymentMethod" value="Online Payment" style="margin-right: 1rem;">
                        <div>
                            <strong>Online Payment</strong>
                            <div style="color: #666; font-size: 0.9rem;">Pay with bKash, Nagad, or Cards</div>
                        </div>
                    </label>
                    <label class="payment-option" style="display: flex; align-items: center; padding: 1rem; border: 2px solid #ddd; border-radius: 8px; cursor: pointer;">
                        <input type="radio" name="paymentMethod" value="Bank Transfer" style="margin-right: 1rem;">
                        <div>
                            <strong>Bank Transfer</strong>
                            <div style="color: #666; font-size: 0.9rem;">Direct bank transfer</div>
                        </div>
                    </label>
                </div>
            </div>
            
            <div class="card" style="padding: 2rem; margin-bottom: 2rem;">
                <h2 style="margin-bottom: 1rem;">Order Items</h2>
                <div id="orderItems"></div>
            </div>
        </div>
        
        <div>
            <div class="order-summary">
                <h2 style="margin-bottom: 1.5rem;">Order Summary</h2>
                <div id="orderSummary"></div>
                <button onclick="placeOrder()" class="btn" style="width: 100%; margin-top: 1rem;">
                    Place Order
                </button>
                <a href="{{ url_for('cart') }}" class="btn btn-secondary" 
                   style="width: 100%; text-align: center; margin-top: 0.5rem; display: block; text-decoration: none;">
                    Back to Cart
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
.payment-option:has(input:checked) {
    border-color: #6a11cb !important;
    background: #f8f5ff;
}

.payment-option:hover {
    border-color: #999 !important;
}

.payment-option input[type="radio"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
}
</style>
<script>
let cart = {};

document.addEventListener('DOMContentLoaded', loadCheckout);

function loadCheckout() {
    fetch('/api/cart/get')
        .then(response => response.json())
        .then(data => {
            cart = data;
            
            if (Object.keys(cart).length === 0) {
                window.location.href = '{{ url_for("products") }}';
                return;
            }
            
            renderCheckout();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to load checkout');
        });
}

function renderCheckout() {
    let total = 0;
    let itemsHtml = '';
    
    for (const [productId, item] of Object.entries(cart)) {
        const subtotal = item.price * item.quantity;
        total += subtotal;
        
        itemsHtml += `
            <div style="display: flex; gap: 1rem; padding: 1rem; border-bottom: 1px solid #ddd;">
                <img src="${item.image}" alt="${item.name}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px;">
                <div style="flex: 1;">
                    <strong>${item.name}</strong>
                    <div style="color: #666; margin-top: 0.25rem;">
                        ৳${item.price.toFixed(2)} × ${item.quantity}
                    </div>
                </div>
                <div style="font-weight: bold;">
                    ৳${subtotal.toFixed(2)}
                </div>
            </div>
        `;
    }
    
    document.getElementById('orderItems').innerHTML = itemsHtml;
    
    const deliveryCharge = 100;
    const grandTotal = total + deliveryCharge;
    
    document.getElementById('orderSummary').innerHTML = `
        <div class="summary-row">
            <span>Items:</span>
            <span>${Object.keys(cart).length}</span>
        </div>
        <div class="summary-row">
            <span>Subtotal:</span>
            <span>৳${total.toFixed(2)}</span>
        </div>
        <div class="summary-row">
            <span>Delivery Charge:</span>
            <span>৳${deliveryCharge.toFixed(2)}</span>
        </div>
        <div class="summary-row total">
            <span>Total:</span>
            <span>৳${grandTotal.toFixed(2)}</span>
        </div>
    `;
}

function placeOrder() {
    if (!confirm('Confirm order placement?')) {
        return;
    }
    
    const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
    
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = 'Processing...';
    
    fetch('/api/order/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            payment_method: paymentMethod
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Redirect to order confirmation page
            window.location.href = '/order/confirmation/' + data.order_id;
        } else {
            alert(data.error || 'Failed to place order');
            btn.disabled = false;
            btn.textContent = 'Place Order';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred');
        btn.disabled = false;
        btn.textContent = 'Place Order';
    });
}
</script>
{% endblock %}
