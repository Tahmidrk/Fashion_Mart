{% extends "base.html" %}

{% block title %}Shopping Cart - Fashion Mart{% endblock %}

{% block content %}
<div class="container">
    <h1 style="margin-bottom: 2rem;">Shopping Cart</h1>
    
    <div id="cartContainer">
        <div class="spinner"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let cart = {};

// Load cart on page load
document.addEventListener('DOMContentLoaded', loadCart);

function loadCart() {
    fetch('/api/cart/get')
        .then(response => response.json())
        .then(data => {
            cart = data;
            renderCart();
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('cartContainer').innerHTML = 
                '<div class="alert alert-error">Failed to load cart</div>';
        });
}

function renderCart() {
    const container = document.getElementById('cartContainer');
    
    if (Object.keys(cart).length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 3rem;">
                <h2>Your cart is empty</h2>
                <p style="margin: 1rem 0;">Start shopping to add items to your cart!</p>
                <a href="${'{{ url_for("products") }}'}" class="btn">Browse Products</a>
            </div>
        `;
        return;
    }
    
    let total = 0;
    let itemsHtml = '';
    
    for (const [productId, item] of Object.entries(cart)) {
        const subtotal = item.price * item.quantity;
        total += subtotal;
        
        itemsHtml += `
            <tr>
                <td><img src="${item.image}" alt="${item.name}" class="cart-item-image"></td>
                <td><strong>${item.name}</strong></td>
                <td>৳${item.price.toFixed(2)}</td>
                <td>
                    <div class="quantity-control">
                        <button onclick="updateQuantity(${productId}, ${item.quantity - 1})">-</button>
                        <input type="number" value="${item.quantity}" min="1" 
                               onchange="updateQuantity(${productId}, this.value)" 
                               style="width: 60px; text-align: center;">
                        <button onclick="updateQuantity(${productId}, ${item.quantity + 1})">+</button>
                    </div>
                </td>
                <td><strong>৳${subtotal.toFixed(2)}</strong></td>
                <td>
                    <button class="btn btn-danger" onclick="removeItem(${productId})" 
                            style="padding: 0.5rem 1rem;">Remove</button>
                </td>
            </tr>
        `;
    }
    
    container.innerHTML = `
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
            <div class="cart-table">
                <table>
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Product</th>
                            <th>Price</th>
                            <th>Quantity</th>
                            <th>Subtotal</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHtml}
                    </tbody>
                </table>
            </div>
            
            <div class="order-summary">
                <h2 style="margin-bottom: 1.5rem;">Order Summary</h2>
                <div class="summary-row">
                    <span>Items:</span>
                    <span>${Object.keys(cart).length}</span>
                </div>
                <div class="summary-row">
                    <span>Subtotal:</span>
                    <span>৳${total.toFixed(2)}</span>
                </div>
                <div class="summary-row total">
                    <span>Total:</span>
                    <span>৳${total.toFixed(2)}</span>
                </div>
                <a href="${'{{ url_for("checkout") }}'}" class="btn" style="width: 100%; text-align: center; margin-top: 1rem; display: block; text-decoration: none;">
                    Proceed to Checkout
                </a>
                <a href="${'{{ url_for("products") }}'}" class="btn btn-secondary" style="width: 100%; text-align: center; margin-top: 0.5rem; display: block; text-decoration: none;">
                    Continue Shopping
                </a>
            </div>
        </div>
    `;
}

function updateQuantity(productId, newQuantity) {
    newQuantity = parseInt(newQuantity);
    
    if (newQuantity < 1) {
        if (confirm('Remove this item from cart?')) {
            removeItem(productId);
        }
        return;
    }
    
    fetch('/api/cart/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ product_id: productId, quantity: newQuantity })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            cart[productId].quantity = newQuantity;
            renderCart();
            updateCartCount();
        } else {
            alert(data.error || 'Failed to update quantity');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred');
    });
}

function removeItem(productId) {
    fetch('/api/cart/remove', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ product_id: productId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            delete cart[productId];
            renderCart();
            updateCartCount();
        } else {
            alert(data.error || 'Failed to remove item');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred');
    });
}
</script>
{% endblock %}
